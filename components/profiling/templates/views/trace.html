{{ define "head" }}
    {{ if .started }}
    <link href="/profiling/vendor/flipclock/flipclock.css?v={{ .Application.GetBuild }}" rel="stylesheet">
    {{ end }}
{{ end }}

{{ define "js" }}
    {{ if .started }}
    <script src="/profiling/vendor/flipclock/flipclock.min.js?v={{ .Application.GetBuild }}"></script>
    {{ end }}

    <script type="text/javascript">
        $(document).ready(function() {
            {{ if .started }}
            $('.clock').FlipClock({{ .duration.Seconds }}, {
                clockFace: 'MinuteCounter'
            });
            {{ else }}
            $('#select-all').click(function() {
                var next = !$(this).data('selected');
                $('#profiles').find(':checkbox').prop('checked', next);
                $(this).text(next ? 'Unselect all' : 'Select all').data('selected', next);
            });
            {{ end }}
        });
    </script>
{{ end }}

{{ define "content" }}
<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Go trace</h1>
    </div>
</div>

{{ if .error }}
<div class="alert alert-danger alert-dismissable">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    {{ .error.Error }}
</div>
{{ end }}

<div class="panel panel-success">
    <div class="panel-heading">
        Run profiling
        {{ if not .started }}
        <div class="pull-right">
            <div class="btn-group">
                <button type="button" class="btn btn-default btn-xs" id="select-all">Select all</button>
            </div>
        </div>
        {{ end }}
    </div>
    <div class="panel-body">
        <form role="form" action="?{{ if .started }}action=stop{{ else }}action=start{{ end }}" method="post" id="profiles">
            {{ if .started }}
            <div class="row">
                <div class="clock" style="width:300px;margin:1em auto;"></div>
            </div>
            {{ else }}
            <div class="form-group">
                {{ range $id, $profile := .profiles }}
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="{{ $profile.GetId }}" name="profile_{{ $profile.GetId }}" value="{{ $profile.GetId }}"{{ if $profile.GetStarted }} checked{{ end }}> {{ $profile.GetDescription }}
                    </label>
                </div>
                {{ end }}
            </div>
            {{ end }}

            <div class="text-center">
                {{ if .started }}
                <button type="submit" class="btn btn-danger" value="stop">Finish profiling</button>
                {{ else }}
                <button type="submit" class="btn btn-success" value="start">Run profiling</button>
                {{ end }}
            </div>
        </form>
    </div>
</div>

<div class="panel panel-info">
    <div class="panel-heading">
        Dumps
        {{ if .remove_all }}
        <div class="pull-right">
            <div class="btn-group">
                <form method="post" action="?action=delete&id=all" class="btn-group btn-group-xs">
                    <button type="submit" class="btn btn-default btn-xs">
                        Remove all
                    </button>
                </form>
            </div>
        </div>
        {{ end }}
    </div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped" id="dumps">
                <thead>
                <tr>
                    <th>Profiles</th>
                    <th>Started</th>
                    <th>Stopped</th>
                    <th>Size</th>
                    <th class="text-right">Actions</th>
                </tr>
                </thead>
                <tbody>
                {{ range $d, $dump := .dumps }}
                <tr{{ if eq $dump.GetStatus 3 }} class="danger"{{ end }}>
                    <td>
                        {{ if eq $dump.GetStatus 1 }}
                            {{ range $p, $profile := $dump.GetProfiles }}
                                {{ $profile.GetId }}
                            {{ end }}
                        {{ else }}
                        <div class="progress" style="width:100%;margin-bottom:0;float:right">
                            <div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                <span class="sr-only">Generation</span>
                            </div>
                        </div>
                        {{ end }}
                    </td>
                    <td>{{ $dump.GetStartedAt.Format "2006.01.02 15:04:05" }}</td>
                    <td>{{ $dump.GetStoppedAt.Format "2006.01.02 15:04:05" }}</td>
                    <td>{{ $dump.GetSize }}</td>
                    <td class="text-right">
                        {{ if and (ne $dump.GetStatus 0) (ne $dump.GetStatus 2) }}
                        <form method="post" action="?action=delete&id={{ $dump.GetId }}" class="btn-group-xs">
                            <a href="?action=download&id={{ $dump.GetId }}" class="btn btn-info btn-icon"><i class="glyphicon glyphicon-download"></i> Download</a>
                            <button type="submit" class="btn btn-danger btn-icon"><i class="glyphicon glyphicon-trash"></i> Delete</button>
                        </form>
                        {{ else }}
                        <div class="progress" style="width:148px;margin-bottom:0;float:right">
                            <div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                <span class="sr-only">Generation</span>
                            </div>
                        </div>
                        {{ end }}
                    </td>
                </tr>
                {{ end }}
                </tbody>
            </table>
        </div>
    </div>
</div>
{{ end }}