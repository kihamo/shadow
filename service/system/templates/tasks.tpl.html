{{ include "frontend" "layout/header.tpl.html" }}

<div class="row">
    <div class="col-xs-6">
        <div class="col-xs-6">
            <div class="panel panel-green">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3">
                            <i class="fa fa-comments fa-5x"></i>
                        </div>
                        <div class="col-xs-9 text-right">
                            <div class="huge" id="workers-count">0</div>
                            <div>Workers</div>
                        </div>
                    </div>
                </div>
                <a href="#workers">
                    <div class="panel-footer">
                        <span class="pull-left">View Details</span>
                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                        <div class="clearfix"></div>
                    </div>
                </a>
            </div>
        </div>
        <div class="col-xs-6">
            <div class="panel panel-red">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3">
                            <i class="fa fa-comments fa-5x"></i>
                        </div>
                        <div class="col-xs-9 text-right">
                            <div class="huge" id="tasks-wait-count">0</div>
                            <div>Wait tasks</div>
                        </div>
                    </div>
                </div>
                <a href="#tasks">
                    <div class="panel-footer">
                        <span class="pull-left">View Details</span>
                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                        <div class="clearfix"></div>
                    </div>
                </a>
            </div>
        </div>
        <div class="col-xs-6">
            <div class="panel panel-yellow">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3">
                            <i class="fa fa-comments fa-5x"></i>
                        </div>
                        <div class="col-xs-9 text-right">
                            <div class="huge" id="goroutines">0</div>
                            <div>Goroutines</div>
                        </div>
                    </div>
                </div>
                <div class="panel-footer" style="height:41px"></div>
            </div>
        </div>
    </div>
    <div class="col-xs-6">
        <div id="stats"></div>
    </div>
</div>

<div class="panel panel-default" id="workers">
    <div class="panel-heading">Workers</div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Created</th>
                    <th>Task ID</th>
                    <th>Task name</th>
                    <th>Task status</th>
                    <th>Task created</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="panel panel-default" id="tasks">
    <div class="panel-heading">Wait tasks</div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Task ID</th>
                    <th>Task name</th>
                    <th>Task created</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    var statsDonut;

    function getTaskStatusName(status) {
      switch(status) {
        case 0:
          return 'wait';
          break;

        case 1:
          return 'process';
          break;

        case 2:
          return 'success';
          break;

        case 3:
          return 'fail';
          break;

        case 4:
          return 'wait repeat';
          break;

        default:
          return 'unknown';
          break;
      }
    }

    function update() {
      $.ajax({
        type: 'GET',
        url: '/system/tasks',
        success: function(r){
          if (!Array.isArray(r.workers)) {
            return;
          }

          var tW = $('#workers tbody').empty();
          var tT = $('#tasks tbody').empty();

          for(var i in r.workers) {
            var worker = r.workers[i];
            var task = worker.task;

            tW.append('<tr>'
              + '<td>' + worker.id + '</td>'
              + '<td>' + new Date(worker.created).toLocaleString() + '</td>'
              + '<td>' + (task ? task.id : '') + '</td>'
              + '<td>' + (task ? task.name : '') + '</td>'
              + '<td>' + (task ? getTaskStatusName(task.status) : '') + '</td>'
              + '<td>' + (task ? new Date(task.created).toLocaleString() : '') + '</td>'
            + '</tr>');
          }

          for(var i in r.tasks_wait) {
            var task = r.tasks_wait[i];

            tT.append('<tr>'
              + '<td>' + task.id + '</td>'
              + '<td>' + task.name + '</td>'
              + '<td>' + new Date(task.created).toLocaleString() + '</td>'
            + '</tr>');
          }

          $('#tasks-title').text(r.tasks_wait.length + ' wait tasks');
          $('#goroutines').text(r.goroutines);
          $('#workers-count').text(r.workers.length);
          $('#tasks-wait-count').text(r.tasks_wait.length);

          statsDonut.data[0].value = r.workers_wait;
          statsDonut.values[0] = r.workers_wait;
          statsDonut.data[1].value = r.workers_busy;
          statsDonut.values[1] = r.workers_busy;
          statsDonut.resizeHandler();
        }
      });
    }

    $(function() {
      statsDonut = new Morris.Donut({
        element: 'stats',
        data: [{
            label: 'Wait workers',
            value: 1
        }, {
            label: 'Busy workers',
            value: 1
        }],
        resize: true
      });

      update();
      setInterval(update, 1000 * 5);
    });
</script>

{{ include "frontend" "layout/footer.tpl.html" }}